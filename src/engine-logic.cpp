#include "engine-logic.hpp"
//#include <charconv>

// a rng table that stores up to 256 values
int rng_table[] = {
  98,
  144,
  208,
  62,
  231,
  85,
  106,
  36,
  8,
  39,
  29,
  28,
  175,
  219,
  235,
  178,
  223,
  111,
  135,
  99,
  244,
  11,
  182,
  219,
  26,
  51,
  131,
  35,
  246,
  76,
  10,
  7,
  32,
  197,
  65,
  108,
  92,
  12,
  90,
  168,
  161,
  183,
  251,
  140,
  147,
  47,
  35,
  65,
  137,
  100,
  251,
  176,
  125,
  33,
  97,
  203,
  43,
  43,
  56,
  165,
  248,
  63,
  20,
  88,
  3,
  138,
  188,
  205,
  163,
  94,
  63,
  214,
  90,
  231,
  60,
  201,
  60,
  229,
  218,
  183,
  28,
  87,
  56,
  143,
  24,
  242,
  206,
  24,
  124,
  223,
  46,
  25,
  125,
  151,
  87,
  7,
  224,
  67,
  74,
  183,
  175,
  167,
  186,
  95,
  111,
  127,
  65,
  212,
  202,
  150,
  2,
  17,
  4,
  171,
  4,
  73,
  142,
  191,
  232,
  191,
  93,
  250,
  12,
  155,
  215,
  78,
  203,
  118,
  240,
  57,
  239,
  19,
  125,
  92,
  104,
  160,
  66,
  1,
  218,
  203,
  224,
  39,
  70,
  3,
  54,
  90,
  87,
  38,
  78,
  253,
  174,
  126,
  122,
  42,
  189,
  7,
  218,
  164,
  153,
  149,
  185,
  116,
  192,
  242,
  234,
  61,
  59,
  114,
  107,
  94,
  196,
  54,
  113,
  233,
  133,
  208,
  208,
  42,
  240,
  169,
  240,
  104,
  94,
  107,
  186,
  188,
  205,
  163,
  94,
  63,
  214,
  90,
  231,
  60,
  201,
  60,
  229,
  218,
  183,
  28,
  87,
  56,
  143,
  24,
  242,
  206,
  24,
  124,
  223,
  46,
  25,
  125,
  151,
  87,
  7,
  224,
  67,
  74,
  183,
  175,
  167,
  186,
  95,
  111,
  127,
  65,
  212,
  202,
  150,
  2,
  17,
  4,
  171,
  4,
  73,
  142,
  191,
  232,
  191,
  93,
  250,
  12,
  155,
  215,
  78,
  203,
  118,
  240,
  57,
  239,
  19,
  125,
  92,
  104,
  160,
  66
};

int GetRandomValue(){
  for (int v : rng_table) {
    static int index = 0;
    int count = sizeof(rng_table) / sizeof(rng_table[0]);

    int value = rng_table[index];
    index = (index + 1) % count;

    return value;
  }
}

void SawyerDelay(float seconds) {
    std::this_thread::sleep_for(std::chrono::duration<float>(seconds));
}

double GetTime() {
  #if __linux__
  struct timespec ts;
  clock_gettime(CLOCK_MONOTONIC, &ts);
  return (double)ts.tv_sec + (double)ts.tv_nsec * 1e-9;
  #endif
  #if _WIN32
  static LARGE_INTEGER frequency;
  static BOOL init = QueryPerformanceFrequency(&frequency);
  LARGE_INTEGER counter;
  QueryPerformanceCounter(&counter);
  return (double)counter.QuadPart / (double)frequency.QuadPart;
  #endif
}

int frameindex(int tfps, int xfps){
  return static_cast<int>(GetTime() * tfps) % xfps;
}

// DO NOT SET THE TARGET FPS OUTSIDE OF THE RENDER LOOP
void TargetFps(float tfps) {
  if (tfps < 1) {
    tfps = 300;
    SawyerDelay(1/tfps);
  }
  else
    SawyerDelay(1/tfps);
}